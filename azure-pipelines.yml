variables:
  NUGET_VERSION: 0.1

trigger:
  branches:
    include:
    - main
  paths:
    include:
    - '**'

jobs:

- job: PG
  pool:
    vmImage: '$(IMAGE)'
  timeoutInMinutes: 20
  strategy:
    maxParallel: 7
    matrix:
      'Win-Default':
        IMAGE: "windows-2022"
      'Ubuntu-22-default':
        IMAGE: "ubuntu-22.04"
      'Ubuntu-20-default':
        IMAGE: "ubuntu-20.04"
      'Ubuntu-20-PGv10':
        IMAGE: "ubuntu-20.04"
        PG_LINUX: 10
      'Ubuntu-20-PGv11':
        IMAGE: "ubuntu-20.04"
        PG_LINUX: 11
      'Ubuntu-20-PGv12':
        IMAGE: "ubuntu-20.04"
        PG_LINUX: 12
      'Ubuntu-20-PGv13':
        IMAGE: "ubuntu-20.04"
        PG_LINUX: 13
      'Ubuntu-20-PGv14':
        IMAGE: "ubuntu-20.04"
        PG_LINUX: 14
      'Ubuntu-20-PGv15':
        IMAGE: "ubuntu-20.04"
        PG_LINUX: 15
      'Ubuntu-20-PGv16':
        IMAGE: "ubuntu-20.04"
        PG_LINUX: 16
      'Ubuntu-18-default':
        IMAGE: "ubuntu-18.04"

  steps:

  - bash: |
      script=https://raw.githubusercontent.com/devizer/test-and-build/master/install-build-tools-bundle.sh; (wget -q -nv --no-check-certificate -O - $script 2>/dev/null || curl -ksSL $script) | bash >/dev/null
      Say --Reset-Stopwatch
      Say "Install DotNet"
      export DOTNET_VERSIONS="5.0 6.0 7.0"
      script=https://raw.githubusercontent.com/devizer/test-and-build/master/lab/install-DOTNET.sh; (wget -q -nv --no-check-certificate -O - $script 2>/dev/null || curl -ksSL $script) | bash; test -s /usr/share/dotnet/dotnet && sudo ln -f -s /usr/share/dotnet/dotnet /usr/local/bin/dotnet
      dotnet --list-sdks
    condition: ne(variables['Agent.OS'], 'Windows_NT')
    displayName: 'Bootstrap on Linux'

  - bash: |
      Say "Installing Postgres v$PG_LINUX on Linux"
      sudo rm -rf /etc/postgresql /var/lib/postgresql
      sudo apt-get install -y -qq postgresql-common |& ( grep Setting || true; )
      sudo /usr/share/postgresql-common/pgdg/apt.postgresql.org.sh -p -v $PG_LINUX -i |& tee $SYSTEM_ARTIFACTSDIRECTORY/postgres-0-installing.txt
    condition: ne(variables['PG_LINUX'], '')
    displayName: 'Postgres on Linux'

  - bash: |
      set -eu; set -o pipefail
      dotnet restore || dotnet restore --disable-parallel
      dotnet test
    displayName: 'Test All'

  - bash: |
      set -eu; set -o pipefail
      d=$PWD
      pushd "$(System.ARTIFACTSDIRECTORY)"
      7z a -mx=1 "Source-$(Agent.JobName).7z" "$d"
      popd
    condition: succeededOrFailed()
    displayName: 'Prepare Artifacts'

  - task: PublishBuildArtifacts@1
    condition: succeededOrFailed()
    displayName: 'Publish'
    inputs:
      pathtoPublish: '$(System.ARTIFACTSDIRECTORY)'
      artifactName: '$(Agent.JobName)'
